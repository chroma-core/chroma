name: Start Tilt services
description: "This action starts Tilt services"
runs:
  using: "composite"
  steps:
    - name: Start minikube
      uses: medyagh/setup-minikube@latest
      with:
        driver: none # uses Docker engine on host instead of Docker-in-Docker
    # tilt ci can automatically build images while bringing up the cluster. However, this results in flaky runs for our usage so we split up image building and pod deployment into separate steps. See https://github.com/chroma-core/chroma/pull/4720.
    - name: Install Tilt, bake images, pre-pull external images
      shell: bash
      env:
        TILT_VERSION: "0.34.2"
      run: |
        parallel --tag --linebuffer ::: \
          "bash -c 'curl -fsSL https://github.com/tilt-dev/tilt/releases/download/v${TILT_VERSION}/tilt.${TILT_VERSION}.linux.x86_64.tar.gz | tar -xzv -C /usr/local/bin tilt'" \
          "docker buildx bake -f .github/actions/tilt/docker-bake.hcl --load" \
          "bash .github/actions/tilt/pull_external_images.sh"
    - name: Start Tilt
      shell: bash
      run: tilt ci
    - name: Forward ports
      shell: bash
      run: |
        # tilt ci does not forward ports
        # https://github.com/tilt-dev/tilt/issues/5964
        kubectl -n chroma port-forward svc/sysdb 50051:50051 &
        kubectl -n chroma port-forward svc/logservice 50052:50051 &
        kubectl -n chroma port-forward svc/rust-log-service 50054:50051 &
        kubectl -n chroma port-forward svc/query-service 50053:50051 &
        kubectl -n chroma port-forward svc/frontend-service 8000:8000 &
        kubectl -n chroma port-forward svc/rust-frontend-service 3000:8000 &
        kubectl -n chroma port-forward svc/minio 9000:9000 &
        kubectl -n chroma port-forward svc/jaeger 16686:16686 &
