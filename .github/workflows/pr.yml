name: PR checks
on:
  pull_request:
    branches:
      - main
      - '**'
  # todo: ignore docs folder?

jobs:
  paths-filter:
    name: Get changed paths
    runs-on: ubuntu-latest
    outputs:
      outside-docs: ${{ steps.changes.outputs.outside-docs }}
    steps:
      - name: Get changed paths
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            outside-docs:
              - '!docs/**'

  python-tests:
    name: Python tests
    needs: paths-filter
    if: needs.paths-filter.outputs.outside-docs == 'true'
    uses: ./.github/workflows/_python-tests.yml

  python-vulnerability-scan:
    name: Python vulnerability scan
    needs: paths-filter
    if: needs.paths-filter.outputs.outside-docs == 'true'
    uses: ./.github/workflows/_python-vulnerability-scan.yml

  javascript-client-tests:
    name: JavaScript client tests
    needs: paths-filter
    if: needs.paths-filter.outputs.outside-docs == 'true'
    uses: ./.github/workflows/_javascript-client-tests.yml

  rust-tests:
    name: Rust tests
    needs: paths-filter
    if: needs.paths-filter.outputs.outside-docs == 'true'
    uses: ./.github/workflows/_rust-tests.yml

  go-tests:
    name: Go tests
    needs: paths-filter
    if: needs.paths-filter.outputs.outside-docs == 'true'
    uses: ./.github/workflows/_go-tests.yml

  check-title:
    name: Check PR Title
    runs-on: ubuntu-latest
    steps:
        - name: Check PR Title
          uses: Slashgear/action-check-pr-title@v4.3.0
          with:
            regexp: '\[(ENH|BUG|DOC|TST|BLD|PERF|TYP|CLN|CHORE|RELEASE)\].*'
            helpMessage: "Please tag your PR title. See https://docs.trychroma.com/contributing#contributing-code-and-ideas. You must push new code to this PR for this check to run again."
        - name: Comment explaining failure
          if: failure()
          uses: actions/github-script@v6
          with:
            script: |
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'Please tag your PR title with one of: \\[ENH | BUG | DOC | TST | BLD | PERF | TYP | CLN | CHORE\\]. See https://docs.trychroma.com/contributing#contributing-code-and-ideas'
              })

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - uses: ./.github/actions/lint
