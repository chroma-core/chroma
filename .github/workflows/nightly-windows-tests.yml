name: Run Windows tests nightly
on:
  workflow_dispatch:
  schedule:
      # 12:21 AM PDT, offseted by a few minutes because:
      # "The schedule event can be delayed during periods of high loads of GitHub Actions workflow runs. High load times include the start of every hour. If the load is sufficiently high enough, some queued jobs may be dropped."
      - cron: '21 9 * * *'
  # This is a temporary hack to get the workflow to run on the main branch
  push:
    branches:
      - eculver/ci-nightly-windows-tests

jobs:
  python-tests:
    name: Python tests (Windows)
    uses: ./.github/workflows/_python-tests.yml
    with:
      property_testing_preset: 'normal'
      platform: '16core-64gb-windows-latest'
      env-file: 'compose-env.windows'

  notify-on-failure:
    name: Notify on failure
    needs: python-tests
    if: failure()
    runs-on: blacksmith-4vcpu-ubuntu-2204
    steps:
      - name: Send PagerDuty alert on failure
        if: ${{ failure() }}
        uses: Entle/action-pagerduty-alert@0.2.0
        with:
          pagerduty-integration-key: '${{ secrets.PAGERDUTY_INTEGRATION_KEY }}'
          pagerduty-dedup-key: nightly-windows-tests-failed